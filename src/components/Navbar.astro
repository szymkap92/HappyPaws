---
import { Image } from 'astro:assets';
import LanguageSwitcher from '@/components/LanguageSwitcher.astro';
import MobileMenu from '@/components/MobileMenu.astro';
import type { Lang, Messages } from '@/lib/i18n';
import { siteData } from '@/data/site';
import logoImage from '@/assets/images/brand/logo.jpg';

interface Props {
  lang: Lang;
  messages: Messages;
  phone: string;
}

const { lang, messages, phone } = Astro.props;
const basePath = `/${lang}/`;
---

<header
  data-navbar
  class="fixed inset-x-0 top-0 z-50 transition duration-300"
>
  <div class="container-shell">
    <div
      data-navbar-shell
      class="mt-3 flex h-[5.5rem] items-center justify-between rounded-2xl border border-transparent bg-transparent px-3 transition duration-300 md:h-[6.5rem] md:px-4"
    >
      <a href={basePath} class="inline-flex items-center gap-3" aria-label="Przejdz do strony glownej Happy Paws">
        <Image
          src={logoImage}
          alt="Happy Paws salon pielegnacji psow logo"
          widths={[96, 128, 176, 224]}
          sizes="(max-width: 768px) 96px, 176px"
          format="webp"
          quality={74}
          class="h-[4.5rem] w-auto md:h-[5.5rem]"
          loading="eager"
          decoding="async"
          fetchpriority="high"
        />
      </a>

      <nav class="hidden items-center gap-5 lg:flex" aria-label="Main navigation">
        <a data-nav-link="about" href={`${basePath}#about`} class="border-b border-transparent px-1 py-2 text-[15px] text-[var(--text-secondary)] transition hover:border-[rgba(233,181,189,0.45)] hover:text-[var(--text-primary)]">{messages.nav.about}</a>
        <a data-nav-link="services" href={`${basePath}#services`} class="border-b border-transparent px-1 py-2 text-[15px] text-[var(--text-secondary)] transition hover:border-[rgba(233,181,189,0.45)] hover:text-[var(--text-primary)]">{messages.nav.services}</a>
        <button data-open-quiz type="button" class="border-b border-transparent px-1 py-2 text-[15px] text-[var(--text-secondary)] transition hover:border-[rgba(233,181,189,0.45)] hover:text-[var(--text-primary)]">{messages.nav.matchCare}</button>
        <a data-nav-link="effects" href={`${basePath}#effects`} class="border-b border-transparent px-1 py-2 text-[15px] text-[var(--text-secondary)] transition hover:border-[rgba(233,181,189,0.45)] hover:text-[var(--text-primary)]">{messages.nav.effects}</a>
        <a data-nav-link="contact" href={`${basePath}#contact`} class="border-b border-transparent px-1 py-2 text-[15px] text-[var(--text-secondary)] transition hover:border-[rgba(233,181,189,0.45)] hover:text-[var(--text-primary)]">{messages.nav.contact}</a>
      </nav>

      <div class="hidden items-center gap-3 lg:flex">
        <a
          href={`tel:${phone.replace(/\s+/g, '')}`}
          class="px-1 py-2 text-xs uppercase tracking-[0.14em] text-[var(--text-secondary)] transition hover:text-[var(--text-primary)]"
        >
          {phone}
        </a>
        <div class="flex items-center gap-1" role="list" aria-label="Media społecznościowe">
          <a
            href={siteData.social.instagram}
            role="listitem"
            aria-label="Instagram"
            target="_blank"
            rel="noopener noreferrer"
            class="flex h-8 w-8 items-center justify-center rounded-full text-[var(--text-muted)] transition hover:text-[var(--text-primary)]"
          >
            <svg viewBox="0 0 24 24" class="h-[15px] w-[15px]" fill="none" stroke="currentColor" stroke-width="1.7" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="5"></rect>
              <circle cx="12" cy="12" r="4"></circle>
              <circle cx="17.3" cy="6.7" r="1"></circle>
            </svg>
          </a>
          <a
            href={siteData.social.facebook}
            role="listitem"
            aria-label="Facebook"
            target="_blank"
            rel="noopener noreferrer"
            class="flex h-8 w-8 items-center justify-center rounded-full text-[var(--text-muted)] transition hover:text-[var(--text-primary)]"
          >
            <svg viewBox="0 0 24 24" class="h-[15px] w-[15px]" fill="currentColor" aria-hidden="true">
              <path d="M13.5 9H16V6h-2.5C10.9 6 9 7.9 9 10.5V13H7v3h2v6h3v-6h2.5l.8-3H12v-2.5c0-.9.6-1.5 1.5-1.5Z"></path>
            </svg>
          </a>
          <a
            href={siteData.social.tiktok}
            role="listitem"
            aria-label="TikTok"
            target="_blank"
            rel="noopener noreferrer"
            class="flex h-8 w-8 items-center justify-center rounded-full text-[var(--text-muted)] transition hover:text-[var(--text-primary)]"
          >
            <svg viewBox="0 0 24 24" class="h-[15px] w-[15px]" fill="currentColor" aria-hidden="true">
              <path d="M15 4c.5 1.7 1.8 3 3.5 3.5V10c-1.3 0-2.5-.4-3.5-1.1v5.8c0 3-2.4 5.3-5.4 5.3S4.2 17.7 4.2 14.7s2.4-5.3 5.4-5.3c.3 0 .6 0 .9.1v2.8c-.3-.1-.6-.2-.9-.2-1.4 0-2.6 1.1-2.6 2.6s1.2 2.6 2.6 2.6 2.6-1.1 2.6-2.6V4H15Z"></path>
            </svg>
          </a>
        </div>
        <a
          href={`${basePath}#contact`}
          class="inline-flex items-center justify-center rounded-lg border border-[rgba(248,212,218,0.44)] bg-transparent px-4 py-2.5 text-xs font-semibold uppercase tracking-[0.12em] text-[var(--text-primary)] transition duration-300 hover:border-[rgba(248,212,218,0.72)] hover:bg-[rgba(233,181,189,0.22)] hover:shadow-[0_10px_24px_rgba(233,181,189,0.2)]"
        >
          {messages.nav.book}
        </a>
        <LanguageSwitcher lang={lang} />
      </div>

      <MobileMenu lang={lang} messages={messages} phone={phone} />
    </div>
  </div>
</header>

<script>
  const navbar = document.querySelector<HTMLElement>('[data-navbar]');

  const setScrolledState = () => {
    if (!navbar) return;
    if (window.scrollY > 14) {
      navbar.classList.add('is-scrolled');
    } else {
      navbar.classList.remove('is-scrolled');
    }
  };

  setScrolledState();
  window.addEventListener('scroll', setScrolledState, { passive: true });

  if (navbar) {
    const shell = navbar.querySelector<HTMLElement>('[data-navbar-shell]');
    const links = navbar.querySelectorAll<HTMLAnchorElement>('[data-nav-link]');
    const sections = document.querySelectorAll<HTMLElement>('[data-section]');

    const linkById = new Map<string, HTMLAnchorElement>();
    links.forEach((link) => {
      const id = link.dataset.navLink;
      if (id) linkById.set(id, link);
    });

    const observer = new IntersectionObserver(
      (entries) => {
        const active = entries
          .filter((entry) => entry.isIntersecting)
          .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];

        if (!active) return;

        const activeId = active.target.id;
        links.forEach((link) => {
          const isActive = link.dataset.navLink === activeId;
          link.classList.toggle('is-active', isActive);
        });
      },
      {
        rootMargin: '-40% 0px -50% 0px',
        threshold: [0.2, 0.45, 0.6]
      }
    );

    sections.forEach((section) => {
      if (linkById.has(section.id)) observer.observe(section);
    });

    if (shell) {
      const toggleShell = () => {
        if (window.scrollY > 12) {
          shell.classList.add('shell-scrolled');
        } else {
          shell.classList.remove('shell-scrolled');
        }
      };

      toggleShell();
      window.addEventListener('scroll', toggleShell, { passive: true });
    }
  }
</script>

<style>
  [data-navbar].is-scrolled {
    background: rgba(11, 7, 6, 0.5);
    backdrop-filter: blur(4px);
  }

  [data-navbar-shell].shell-scrolled {
    border-color: rgba(248, 212, 218, 0.24);
    background: rgba(18, 11, 9, 0.68);
    backdrop-filter: blur(12px);
  }

  [data-nav-link].is-active {
    border-bottom-color: rgba(233, 181, 189, 0.55);
    color: var(--text-primary);
    opacity: 1;
  }
</style>
