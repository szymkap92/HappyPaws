---
import LanguageSwitcher from '@/components/LanguageSwitcher.astro';
import type { Lang, Messages } from '@/lib/i18n';
import { siteData } from '@/data/site';

interface Props {
  lang: Lang;
  messages: Messages;
  phone: string;
}

const { lang, messages, phone } = Astro.props;
const basePath = `/${lang}/`;
---

<div class="md:hidden">
  <button
    type="button"
    class="icon-btn"
    data-mobile-menu-trigger
    aria-label={messages.common.menu}
    aria-expanded="false"
    aria-controls="mobile-menu-overlay"
  >
    <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
      <path d="M4 7h16M4 12h16M4 17h16" stroke-linecap="round" />
    </svg>
  </button>

  <div
    id="mobile-menu-overlay"
    data-mobile-menu
    class="pointer-events-none fixed inset-0 z-[140] opacity-0 transition duration-300"
    aria-hidden="true"
    hidden
    inert
  >
    <button
      class="absolute inset-0 bg-[rgba(6,4,3,0.95)] backdrop-blur-[8px]"
      data-mobile-menu-close
      aria-label={messages.common.close}
    ></button>
    <div
      class="absolute inset-0 flex flex-col bg-[linear-gradient(165deg,#1d130f_0%,#100a08_100%)] px-6 pt-7"
      style="padding-bottom: calc(1.75rem + env(safe-area-inset-bottom, 0px));"
    >
      <div class="flex items-center justify-between gap-3">
        <span class="font-display text-3xl text-gradient">Happy Paws</span>
        <button class="icon-btn" type="button" data-mobile-menu-close aria-label={messages.common.close}>
          <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke-linecap="round" />
          </svg>
        </button>
      </div>

      <nav aria-label="Mobile" class="mt-8 flex-1 space-y-3 overflow-y-auto pr-1">
        <a data-mobile-menu-link href={`${basePath}#about`} class="flex min-h-[56px] items-center rounded-2xl border border-[var(--line)] bg-[rgba(36,23,18,0.66)] px-5 text-base text-[var(--text-primary)] transition hover:border-[var(--line-strong)] hover:bg-[rgba(233,181,189,0.1)]">{messages.nav.about}</a>
        <a data-mobile-menu-link href={`${basePath}#services`} class="flex min-h-[56px] items-center rounded-2xl border border-[var(--line)] bg-[rgba(36,23,18,0.66)] px-5 text-base text-[var(--text-primary)] transition hover:border-[var(--line-strong)] hover:bg-[rgba(233,181,189,0.1)]">{messages.nav.services}</a>
        <button data-open-quiz data-mobile-menu-close type="button" class="flex min-h-[56px] w-full items-center rounded-2xl border border-[var(--line)] bg-[rgba(36,23,18,0.66)] px-5 text-left text-base text-[var(--text-primary)] transition hover:border-[var(--line-strong)] hover:bg-[rgba(233,181,189,0.1)]">{messages.nav.matchCare}</button>
        <a data-mobile-menu-link href={`${basePath}#effects`} class="flex min-h-[56px] items-center rounded-2xl border border-[var(--line)] bg-[rgba(36,23,18,0.66)] px-5 text-base text-[var(--text-primary)] transition hover:border-[var(--line-strong)] hover:bg-[rgba(233,181,189,0.1)]">{messages.nav.effects}</a>
        <a data-mobile-menu-link href={`${basePath}#contact`} class="flex min-h-[56px] items-center rounded-2xl border border-[var(--line)] bg-[rgba(36,23,18,0.66)] px-5 text-base text-[var(--text-primary)] transition hover:border-[var(--line-strong)] hover:bg-[rgba(233,181,189,0.1)]">{messages.nav.contact}</a>
      </nav>

      <div class="mt-6 space-y-4 border-t border-[var(--line)] pt-5">
        <a href={`tel:${phone.replace(/\s+/g, '')}`} class="inline-flex items-center gap-2 text-sm text-[var(--text-secondary)]">
          <span class="h-2 w-2 rounded-full bg-blush"></span>
          {phone}
        </a>
        <div class="flex items-center gap-2" role="list" aria-label="Media społecznościowe">
          <a
            href={siteData.social.instagram}
            role="listitem"
            aria-label="Instagram"
            target="_blank"
            rel="noopener noreferrer"
            class="icon-btn"
          >
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.7" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="5"></rect>
              <circle cx="12" cy="12" r="4"></circle>
              <circle cx="17.3" cy="6.7" r="1"></circle>
            </svg>
          </a>
          <a
            href={siteData.social.facebook}
            role="listitem"
            aria-label="Facebook"
            target="_blank"
            rel="noopener noreferrer"
            class="icon-btn"
          >
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor" aria-hidden="true">
              <path d="M13.5 9H16V6h-2.5C10.9 6 9 7.9 9 10.5V13H7v3h2v6h3v-6h2.5l.8-3H12v-2.5c0-.9.6-1.5 1.5-1.5Z"></path>
            </svg>
          </a>
          <a
            href={siteData.social.tiktok}
            role="listitem"
            aria-label="TikTok"
            target="_blank"
            rel="noopener noreferrer"
            class="icon-btn"
          >
            <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor" aria-hidden="true">
              <path d="M15 4c.5 1.7 1.8 3 3.5 3.5V10c-1.3 0-2.5-.4-3.5-1.1v5.8c0 3-2.4 5.3-5.4 5.3S4.2 17.7 4.2 14.7s2.4-5.3 5.4-5.3c.3 0 .6 0 .9.1v2.8c-.3-.1-.6-.2-.9-.2-1.4 0-2.6 1.1-2.6 2.6s1.2 2.6 2.6 2.6 2.6-1.1 2.6-2.6V4H15Z"></path>
            </svg>
          </a>
        </div>
        <a data-mobile-menu-link href={`${basePath}#contact`} class="btn-primary w-full min-h-[52px]">{messages.nav.book}</a>
        <LanguageSwitcher lang={lang} compact />
      </div>
    </div>
  </div>
</div>

<script>
  const trigger = document.querySelector<HTMLButtonElement>('[data-mobile-menu-trigger]');
  const menu = document.querySelector<HTMLElement>('[data-mobile-menu]');

  if (trigger && menu) {
    if (menu.parentElement !== document.body) {
      document.body.appendChild(menu);
    }

    const closers = menu.querySelectorAll<HTMLElement>('[data-mobile-menu-close], [data-mobile-menu-link]');
    let savedScrollY = 0;

    const lockBody = () => {
      savedScrollY = window.scrollY;
      document.body.classList.add('overflow-hidden');
      document.body.style.position = 'fixed';
      document.body.style.top = `-${savedScrollY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      document.body.style.width = '100%';
    };

    const unlockBody = () => {
      document.body.classList.remove('overflow-hidden');
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.width = '';
      window.scrollTo(0, savedScrollY);
    };

    const setClosedState = () => {
      menu.classList.add('pointer-events-none', 'opacity-0');
      menu.setAttribute('aria-hidden', 'true');
      menu.setAttribute('hidden', '');
      menu.setAttribute('inert', '');
      trigger.setAttribute('aria-expanded', 'false');
    };

    const close = (restoreFocus = true) => {
      setClosedState();
      unlockBody();
      if (restoreFocus) trigger.focus();
    };

    const open = () => {
      menu.removeAttribute('hidden');
      menu.removeAttribute('inert');
      menu.setAttribute('aria-hidden', 'false');
      trigger.setAttribute('aria-expanded', 'true');
      lockBody();
      requestAnimationFrame(() => {
        menu.classList.remove('pointer-events-none', 'opacity-0');
      });

      const firstInteractive = menu.querySelector<HTMLElement>(
        '[data-mobile-menu-close][aria-label], [data-mobile-menu-link], [data-open-quiz]'
      );
      firstInteractive?.focus();
    };

    setClosedState();

    trigger.addEventListener('click', () => {
      if (menu.hasAttribute('hidden')) {
        open();
      } else {
        close();
      }
    });

    closers.forEach((item) => item.addEventListener('click', close));

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !menu.hasAttribute('hidden')) close();
    });

    const onResize = () => {
      if (window.innerWidth >= 768 && !menu.hasAttribute('hidden')) {
        close(false);
      }
    };

    window.addEventListener('resize', onResize);
  }
</script>
