---
import { siteData, t } from '@/data/site';
import type { Lang, Messages } from '@/lib/i18n';

interface Props {
  lang: Lang;
  messages: Messages;
}

const { lang, messages } = Astro.props;
const web3FormsKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY ?? '';
const formspreeEndpoint = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT ?? '';
const hasFormProvider = Boolean(web3FormsKey || formspreeEndpoint);
const missingFieldMessage =
  lang === 'pl'
    ? 'Uzupełnij wymagane pola i podaj poprawny numer telefonu.'
    : lang === 'en'
      ? 'Please complete required fields and provide a valid phone number.'
      : 'Bitte Pflichtfelder ausfüllen und eine gültige Telefonnummer angeben.';
const socialLabels = {
  pl: {
    instagram: 'Instagram - wkrótce',
    facebook: 'Facebook - wkrótce',
    tiktok: 'TikTok - wkrótce'
  },
  en: {
    instagram: 'Instagram - coming soon',
    facebook: 'Facebook - coming soon',
    tiktok: 'TikTok - coming soon'
  },
  de: {
    instagram: 'Instagram - bald verfügbar',
    facebook: 'Facebook - bald verfügbar',
    tiktok: 'TikTok - bald verfügbar'
  }
}[lang];
const mapLabels = {
  pl: {
    title: 'Lokalizacja salonu',
    mapTitle: 'Mapa dojazdu Happy Paws w Dębicy'
  },
  en: {
    title: 'Studio location',
    mapTitle: 'Happy Paws location map in Debica'
  },
  de: {
    title: 'Standort des Studios',
    mapTitle: 'Standortkarte von Happy Paws in Debica'
  }
}[lang];
const mapEmbedUrl = 'https://maps.google.com/maps?q=D%C4%99bica%2039-200&t=&z=13&ie=UTF8&iwloc=&output=embed';
---

<section id="contact" class="relative section-wrap pb-20" data-section>
  <div class="pointer-events-none absolute inset-0 bg-[linear-gradient(180deg,rgba(25,16,13,0.42),rgba(233,181,189,0.06))]" aria-hidden="true"></div>
  <div class="container-shell">
    <div class="mx-auto max-w-4xl text-center">
      <h2 class="section-heading">{t(siteData.contactSection.title, lang)}</h2>
      <p class="section-copy mx-auto">{t(siteData.contactSection.description, lang)}</p>
    </div>

    <div class="mx-auto mt-10 grid max-w-6xl gap-6 lg:grid-cols-[0.95fr_1.05fr]">
      <aside class="card-elevated rounded-3xl p-6">
        <div class="space-y-5">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-[var(--text-muted)]">{messages.common.phone}</p>
            <a href={`tel:${siteData.phone.replace(/\s+/g, '')}`} class="mt-1 inline-block text-lg font-semibold text-[var(--text-primary)] hover:text-blush">
              {siteData.phone}
            </a>
          </div>

          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-[var(--text-muted)]">{messages.common.location}</p>
            <p class="mt-1 text-[var(--text-secondary)]">{siteData.location}</p>
          </div>

          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-[var(--text-muted)]">{messages.common.hours}</p>
            <p class="mt-1 text-[var(--text-secondary)]">{siteData.hours}</p>
          </div>

          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-[var(--text-muted)]">{messages.common.social}</p>
            <div class="mt-3 flex gap-2">
              <button type="button" class="icon-btn" aria-label={socialLabels.instagram} disabled>
                <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.7">
                  <rect x="3" y="3" width="18" height="18" rx="5"></rect>
                  <circle cx="12" cy="12" r="4"></circle>
                  <circle cx="17.3" cy="6.7" r="1"></circle>
                </svg>
              </button>
              <button type="button" class="icon-btn" aria-label={socialLabels.facebook} disabled>
                <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
                  <path d="M13.5 9H16V6h-2.5C10.9 6 9 7.9 9 10.5V13H7v3h2v6h3v-6h2.5l.8-3H12v-2.5c0-.9.6-1.5 1.5-1.5Z"></path>
                </svg>
              </button>
              <button type="button" class="icon-btn" aria-label={socialLabels.tiktok} disabled>
                <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
                  <path d="M15 4c.5 1.7 1.8 3 3.5 3.5V10c-1.3 0-2.5-.4-3.5-1.1v5.8c0 3-2.4 5.3-5.4 5.3S4.2 17.7 4.2 14.7s2.4-5.3 5.4-5.3c.3 0 .6 0 .9.1v2.8c-.3-.1-.6-.2-.9-.2-1.4 0-2.6 1.1-2.6 2.6s1.2 2.6 2.6 2.6 2.6-1.1 2.6-2.6V4H15Z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </aside>

      <div class="card-elevated rounded-3xl p-6">
        <h3 class="font-display text-3xl text-[var(--text-primary)]">{messages.form.title}</h3>

        {
          !hasFormProvider && (
            <p class="mt-3 rounded-xl border border-[rgba(242,167,161,0.45)] bg-[rgba(242,167,161,0.08)] px-3 py-2 text-sm text-[var(--error)]">
              {messages.form.configMissing}
            </p>
          )
        }

        <form
          class="mt-5 space-y-4"
          id="contact-form"
          data-contact-form
          data-lang={lang}
          data-web3-key={web3FormsKey}
          data-formspree-endpoint={formspreeEndpoint}
          data-missing-fields-message={missingFieldMessage}
          data-success-message={messages.form.success}
          data-error-message={messages.form.error}
          data-config-missing-message={messages.form.configMissing}
          novalidate
        >
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="space-y-1.5 text-sm text-[var(--text-secondary)]">
              <span>{messages.form.name} *</span>
              <input
                class="w-full rounded-xl border border-[var(--line)] bg-[rgba(17,11,9,0.75)] px-3 py-2.5 text-[var(--text-primary)] outline-none transition focus:border-[var(--line-strong)]"
                type="text"
                name="name"
                autocomplete="name"
                required
                minlength="2"
                data-focus-name
              />
            </label>

            <label class="space-y-1.5 text-sm text-[var(--text-secondary)]">
              <span>{messages.form.phone} *</span>
              <input
                class="w-full rounded-xl border border-[var(--line)] bg-[rgba(17,11,9,0.75)] px-3 py-2.5 text-[var(--text-primary)] outline-none transition focus:border-[var(--line-strong)]"
                type="tel"
                name="phone"
                autocomplete="tel"
                required
              />
            </label>
          </div>

          <label class="space-y-1.5 text-sm text-[var(--text-secondary)]">
            <span>{messages.form.dogName} *</span>
            <input
              class="w-full rounded-xl border border-[var(--line)] bg-[rgba(17,11,9,0.75)] px-3 py-2.5 text-[var(--text-primary)] outline-none transition focus:border-[var(--line-strong)]"
              type="text"
              name="dogName"
              required
              minlength="2"
            />
          </label>

          <label class="space-y-1.5 text-sm text-[var(--text-secondary)]">
            <span>{messages.form.message} *</span>
            <textarea
              class="min-h-28 w-full rounded-xl border border-[var(--line)] bg-[rgba(17,11,9,0.75)] px-3 py-2.5 text-[var(--text-primary)] outline-none transition focus:border-[var(--line-strong)]"
              name="message"
              required
              minlength="10"
            ></textarea>
          </label>

          <label class="inline-flex items-start gap-2 text-sm text-[var(--text-secondary)]">
            <input type="checkbox" name="consent" class="mt-1 h-4 w-4 rounded border-[var(--line)] bg-transparent" />
            <span>{messages.form.consent}</span>
          </label>

          <div class="hidden" aria-hidden="true">
            <label>
              Company
              <input type="text" name="company" tabindex="-1" autocomplete="off" />
            </label>
          </div>

          <button
            class={`btn-primary w-full sm:w-auto ${!hasFormProvider ? 'cursor-not-allowed opacity-60' : ''}`}
            type="submit"
            disabled={!hasFormProvider}
            aria-disabled={!hasFormProvider ? 'true' : 'false'}
          >
            {messages.form.submit}
          </button>
          <p data-form-status class="text-sm text-[var(--text-muted)]" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <div class="mx-auto mt-6 max-w-6xl">
      <div class="card-elevated rounded-3xl p-3 sm:p-4">
        <div class="mb-3 flex flex-wrap items-center justify-between gap-2 px-1">
          <p class="text-xs uppercase tracking-[0.2em] text-[var(--text-muted)]">{mapLabels.title}</p>
          <p class="text-sm text-[var(--text-secondary)]">{siteData.location}</p>
        </div>
        <div class="overflow-hidden rounded-2xl border border-[var(--line)] bg-[rgba(16,10,8,0.74)]">
          <iframe
            title={mapLabels.mapTitle}
            src={mapEmbedUrl}
            class="h-[270px] w-full sm:h-[320px]"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.querySelector<HTMLFormElement>('[data-contact-form]');
  const status = document.querySelector<HTMLElement>('[data-form-status]');
  const contactSection = document.getElementById('contact');
  const focusNameInput = document.querySelector<HTMLInputElement>('[data-focus-name]');

  window.addEventListener('quiz:message', () => {
    if (!contactSection) return;
    contactSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    setTimeout(() => {
      focusNameInput?.focus();
    }, 400);
  });

  if (form && status) {
    const web3Key = form.dataset.web3Key?.trim() ?? '';
    const formspree = form.dataset.formspreeEndpoint?.trim() ?? '';
    const missingFieldsMessage =
      form.dataset.missingFieldsMessage ?? 'Please complete required fields and provide a valid phone number.';
    const successMessage = form.dataset.successMessage ?? 'Message sent.';
    const errorMessage = form.dataset.errorMessage ?? 'Message could not be sent.';
    const configMissingMessage =
      form.dataset.configMissingMessage ?? 'Configure form provider in env to enable submissions.';

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      status.className = 'text-sm text-[var(--text-muted)]';
      status.textContent = '';

      if (!web3Key && !formspree) {
        status.className = 'text-sm text-[var(--error)]';
        status.textContent = configMissingMessage;
        return;
      }

      const formData = new FormData(form);
      const honeypot = String(formData.get('company') ?? '').trim();
      if (honeypot.length > 0) return;

      const name = String(formData.get('name') ?? '').trim();
      const phone = String(formData.get('phone') ?? '').trim();
      const dogName = String(formData.get('dogName') ?? '').trim();
      const message = String(formData.get('message') ?? '').trim();

      const validPhone = /^[+]?[-\d\s()]{7,20}$/.test(phone);
      if (!name || !dogName || !message || message.length < 10 || !validPhone) {
        status.className = 'text-sm text-[var(--error)]';
        status.textContent = missingFieldsMessage;
        return;
      }

      let endpoint = '';
      let payload = formData;
      const headers: Record<string, string> = {};

      if (formspree) {
        endpoint = formspree;
        headers.Accept = 'application/json';
      } else if (web3Key) {
        endpoint = 'https://api.web3forms.com/submit';
        payload.append('access_key', web3Key);
        payload.append('subject', 'Nowa wiadomość ze strony Happy Paws');
        payload.append('from_name', 'Happy Paws Kontakt');
      } else {
        status.className = 'text-sm text-[var(--error)]';
        status.textContent = configMissingMessage;
        return;
      }

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          body: payload,
          headers
        });

        const json = await response.json().catch(() => null);
        const isSuccess =
          response.ok && (formspree ? true : Boolean(json && (json.success === true || json.message)));

        if (!isSuccess) {
          throw new Error('Form submission failed');
        }

        form.reset();
        status.className = 'text-sm text-[var(--success)]';
        status.textContent = successMessage;
      } catch {
        status.className = 'text-sm text-[var(--error)]';
        status.textContent = errorMessage;
      }
    });
  }
</script>
